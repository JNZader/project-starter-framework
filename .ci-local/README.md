# CI-Local: Universal CI Simulation

Reproduce tu CI/CD localmente antes de push. Si pasa local → pasa en GitHub Actions/GitLab CI.

## Stack Soportados (auto-detectados)

| Stack | Build Tool | Lint | Test |
|-------|------------|------|------|
| Java | Gradle | spotlessCheck | ./gradlew test |
| Java | Maven | spotless:check | ./mvnw test |
| Node.js | npm/yarn/pnpm | lint | test |
| Python | pip/poetry | ruff/pylint | pytest |
| Go | go | golangci-lint | go test |
| Rust | cargo | clippy | cargo test |

## Instalación (30 segundos)

### Copiar a un proyecto nuevo

```bash
# Copiar carpeta completa
cp -r .ci-local /path/to/new-project/

# En el nuevo proyecto
cd /path/to/new-project
./.ci-local/install.sh      # Linux/Mac
# o
.\.ci-local\install.ps1     # Windows
```

### Dependencias opcionales

```bash
# Semgrep (análisis de seguridad, muy recomendado)
pip install semgrep

# Docker (requerido para CI simulation)
# Instalar Docker Desktop
```

## Uso

### Automático (hooks)

```bash
git commit -m "..."   # → pre-commit: AI check + lint + security (~30s)
                      # → commit-msg: valida mensaje sin AI attribution
git push              # → pre-push: CI completo en Docker (~3min)
```

### AI Attribution Blocker

Los hooks bloquean automáticamente:
- `Co-authored-by: Claude`, `Co-authored-by: GPT`, etc.
- `Made by Claude`, `Generated by AI`, `Written by GPT`
- Referencias a `@anthropic.com`, `@openai.com`
- Nombres de modelos: `claude opus`, `gpt-4`, `chatgpt`, etc.

**Tú eres el único autor de tu código.**

### Manual

```bash
# Windows
.\.ci-local\ci-local.ps1 quick    # Lint + compile
.\.ci-local\ci-local.ps1 full     # CI completo
.\.ci-local\ci-local.ps1 shell    # Shell en entorno CI
.\.ci-local\ci-local.ps1 detect   # Ver stack detectado

# Linux/Mac
./.ci-local/ci-local.sh quick
./.ci-local/ci-local.sh full
./.ci-local/ci-local.sh shell
./.ci-local/ci-local.sh detect
```

### Skipear hooks (emergencia)

```bash
git commit --no-verify
git push --no-verify
```

## Como Funciona

```
Developer workflow:

1. Editar codigo
2. git add .
3. git commit -m "feat: add feature"
     |
     pre-commit hook:
     - [1/3] Verificar atribucion AI (BLOQUEADO si encuentra)
     - [2/3] Scan de seguridad Semgrep (reglas locales)
     - [3/3] Compile check rapido
     |
     commit-msg hook:
     - Validar formato conventional commit
     |
4. git push
     |
     pre-push hook:
     - Detectar stack (Java/Node/Python/Go/Rust)
     - Generar Dockerfile para el stack
     - Construir imagen Docker (con cache de hash)
     - Ejecutar test suite completo en contenedor
     |
5. Push exitoso → CI remoto pasara
```

## Estructura

```
.ci-local/
├── ci-local.ps1      # Script principal (Windows)
├── ci-local.sh       # Script principal (Linux/Mac)
├── install.ps1       # Instalador Windows
├── install.sh        # Instalador Linux/Mac
├── semgrep.yml       # Reglas de seguridad
├── README.md         # Esta guía
├── hooks/
│   ├── pre-commit    # AI check + lint + security
│   ├── commit-msg    # Valida mensaje sin AI attribution
│   └── pre-push      # CI simulation en Docker
└── docker/
    └── *.Dockerfile  # Se generan automáticamente
```

## Personalización

### Agregar reglas Semgrep específicas

Editar `.ci-local/semgrep.yml` o crear `.semgrep.yml` en la raíz.

### Cambiar comandos de lint/test

Editar las funciones `detect_stack()` en los scripts.

### Docker image custom

Editar los Dockerfiles en `.ci-local/docker/` después de la primera ejecución.

## FAQ

**¿Por qué falla en CI pero no en ci-local?**
- Verifica que Docker esté corriendo con la misma imagen
- Usa `ci-local.sh shell` para debug interactivo

**¿Cómo acelerar el pre-push?**
- El script detecta módulos modificados y solo testea esos
- Usa `--no-verify` si estás seguro (no recomendado)

**¿Funciona sin Docker?**
- Los hooks de pre-commit funcionan sin Docker
- El pre-push requiere Docker para simular CI real
