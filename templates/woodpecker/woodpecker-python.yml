# ===========================================
# Woodpecker CI for Python Projects
# ===========================================
# Copy to: .woodpecker.yml
#
# MINIMAL CI - runs on push, pull requests, tags, and manual triggers.
# Run full validation locally: ./.ci-local/ci-local.sh full
#
# Uses pip by default. See commented alternatives for poetry/uv.
#
# Caching: Woodpecker does not have declarative cache.
# Mount a volume for pip cache on the server to speed up builds.
# ===========================================

when:
  - event: push
    branch: main
  - event: pull_request
  - event: tag
  - event: manual

steps:
  - name: lint
    image: python:3.12-slim  # Change: 3.10, 3.11, 3.12, 3.13
    commands:
      - python -m pip install --upgrade pip
      - pip install ruff mypy
      - ruff check .
      - mypy . --ignore-missing-imports
    failure: ignore

  - name: build
    image: python:3.12-slim  # Change: 3.10, 3.11, 3.12, 3.13
    commands:
      - python -m pip install --upgrade pip
      - pip install -r requirements.txt || true
      - pip install -r requirements-dev.txt || true

# ===========================================
# Alternative: Poetry
# ===========================================
# Replace the build and lint steps above with:
#
#   - name: lint
#     image: python:3.12-slim
#     commands:
#       - pip install poetry
#       - poetry install
#       - poetry run ruff check .
#       - poetry run mypy . --ignore-missing-imports
#     failure: ignore
#
#   - name: build
#     image: python:3.12-slim
#     commands:
#       - pip install poetry
#       - poetry install

# ===========================================
# Alternative: uv
# ===========================================
# Replace the build and lint steps above with:
#
#   - name: lint
#     image: python:3.12-slim
#     commands:
#       - pip install uv
#       - uv sync
#       - uv run ruff check .
#       - uv run mypy . --ignore-missing-imports
#     failure: ignore
#
#   - name: build
#     image: python:3.12-slim
#     commands:
#       - pip install uv
#       - uv sync

# ===========================================
# DOCKER - Only on version tags
# ===========================================
# Uncomment to enable Docker builds on tags.
# Requires woodpeckerci/plugin-docker-buildx.
#
#   - name: docker
#     image: woodpeckerci/plugin-docker-buildx
#     settings:
#       repo: registry.example.com/my-app
#       tag: ${CI_COMMIT_TAG}
#       dockerfile: Dockerfile
#     when:
#       - event: tag

# ===========================================
# PUBLISH to PyPI - Only on version tags
# ===========================================
#   - name: publish
#     image: python:3.12-slim
#     commands:
#       - pip install build twine
#       - python -m build
#       - twine upload dist/*
#     environment:
#       TWINE_USERNAME: __token__
#       TWINE_PASSWORD:
#         from_secret: pypi_token
#     when:
#       - event: tag
