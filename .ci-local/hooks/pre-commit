#!/bin/bash
# =============================================================================
# PRE-COMMIT: Universal quick checks before commit
# =============================================================================
# Detecta el stack y ejecuta lint + compile rÃ¡pido
# Tiempo: ~30-60 segundos
# =============================================================================

set -e

# Encontrar directorio .ci-local
HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
if [[ -d "$HOOK_DIR/../.ci-local" ]]; then
    CI_LOCAL_DIR="$HOOK_DIR/../.ci-local"
elif [[ -d "$(git rev-parse --show-toplevel)/.ci-local" ]]; then
    CI_LOCAL_DIR="$(git rev-parse --show-toplevel)/.ci-local"
else
    echo "Warning: .ci-local not found, skipping pre-commit checks"
    exit 0
fi

PROJECT_DIR="$(dirname "$CI_LOCAL_DIR")"

# Source shared library for colors and detect_stack
source "$CI_LOCAL_DIR/../lib/common.sh"

echo -e "${YELLOW}[pre-commit] Running quick checks...${NC}"

# =============================================================================
# CHECK: No AI attribution in staged files
# =============================================================================
echo -e "${YELLOW}[1/3] Checking for AI attribution...${NC}"

# Patrones prohibidos (case insensitive)
AI_PATTERNS=(
    "co-authored-by:.*claude"
    "co-authored-by:.*anthropic"
    "co-authored-by:.*gpt"
    "co-authored-by:.*openai"
    "co-authored-by:.*copilot"
    "co-authored-by:.*gemini"
    "co-authored-by:.*\bai\b"
    "made by claude"
    "made by gpt"
    "made by ai"
    "generated by claude"
    "generated by gpt"
    "generated by ai"
    "generated with claude"
    "generated with ai"
    "written by claude"
    "written by ai"
    "created by claude"
    "created by ai"
    "assisted by claude"
    "assisted by ai"
    "with help from claude"
    "claude code"
    "made by anthropic"
    "powered by anthropic"
    "created by anthropic"
    "made by openai"
    "powered by openai"
    "created by openai"
    "@anthropic.com"
    "@openai.com"
)

# Check actual staged content using git show :0:file
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -vE '\.(png|jpg|jpeg|gif|ico|woff|ttf|eot|svg|lock)$' || true)

if [[ -n "$STAGED_FILES" ]]; then
    for pattern in "${AI_PATTERNS[@]}"; do
        while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            if git show ":0:$file" 2>/dev/null | grep -iqE "$pattern"; then
                echo -e "${RED}[BLOCKED] AI attribution found in staged content: $file${NC}"
                echo -e "${RED}  Pattern matched: $pattern${NC}"
                git show ":0:$file" | grep -inE "$pattern" | head -3 | while IFS= read -r line; do
                    echo -e "${RED}    $line${NC}"
                done
                echo ""
                echo -e "${YELLOW}Remove AI attribution before committing.${NC}"
                exit 1
            fi
        done <<< "$STAGED_FILES"
    done
    echo -e "${GREEN}  No AI attribution found${NC}"
fi

# Semgrep security scan - native or Docker fallback
SEMGREP_CMD=""
SEMGREP_MODE=""
if command -v semgrep &> /dev/null; then
    SEMGREP_CMD="native"
    SEMGREP_MODE="native"
elif command -v docker &> /dev/null && docker info &> /dev/null 2>&1; then
    SEMGREP_CMD="docker"
    SEMGREP_MODE="Docker"
fi

if [[ -n "$SEMGREP_CMD" ]]; then
    echo -e "${YELLOW}[2/3] Security scan (Semgrep via $SEMGREP_MODE)...${NC}"
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(java|kt|js|ts|py|go|rs)$' || true)
    if [[ -n "$STAGED_FILES" ]]; then
        if [[ "$SEMGREP_CMD" == "native" ]]; then
            echo "$STAGED_FILES" | tr '\n' '\0' | xargs -0 semgrep --config=.ci-local/semgrep.yml --severity=ERROR --quiet 2>/dev/null || {
                echo -e "${RED}Semgrep found issues${NC}"
                exit 1
            }
        else
            docker run --rm -v "${PROJECT_DIR}:/src" -w /src returntocorp/semgrep \
                semgrep --config=/src/.ci-local/semgrep.yml --severity=ERROR --quiet $STAGED_FILES 2>/dev/null || {
                echo -e "${RED}Semgrep found issues${NC}"
                exit 1
            }
        fi
        echo -e "${GREEN}Security OK${NC}"
    else
        echo -e "${GREEN}No files to scan${NC}"
    fi
else
    echo -e "${YELLOW}[2/3] Semgrep not available, skipping (install semgrep or use Docker)${NC}"
fi

# Quick compile/lint basado en el stack
echo -e "${YELLOW}[3/3] Quick compile check...${NC}"
cd "$PROJECT_DIR"

# Use shared stack detection from lib/common.sh
detect_stack

case "$STACK_TYPE" in
    java-gradle)
        ./gradlew spotlessCheck classes --no-daemon -q 2>/dev/null || {
            echo -e "${RED}Gradle check failed. Run: ./gradlew spotlessApply${NC}"
            exit 1
        }
        ;;
    java-maven)
        ./mvnw compile -q 2>/dev/null || exit 1
        ;;
    node)
        if [[ "$BUILD_TOOL" == "pnpm" ]]; then
            pnpm lint --silent 2>/dev/null || exit 1
        elif [[ "$BUILD_TOOL" == "yarn" ]]; then
            yarn lint --silent 2>/dev/null || exit 1
        else
            npm run lint --silent 2>/dev/null || exit 1
        fi
        ;;
    rust)
        cargo check --quiet 2>/dev/null || exit 1
        ;;
    go)
        go build ./... 2>/dev/null || exit 1
        ;;
esac

echo -e "${GREEN}Compile OK${NC}"
echo -e "${GREEN}[pre-commit] All checks passed!${NC}"
